# Reference: https://docs.gitlab.com/ee/ci/yaml/workflow.html#switch-between-branch-pipelines-and-merge-request-pipelines
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH

# Run all pipelines if one of the following criteria met
# - a commit pushed to default branch
# - a merge request targeting default branch
# - any changes in root directory
# noinspection YAMLSchemaValidation,YAMLSchemaValidation,YAMLSchemaValidation
.run_all_rules: &run_all_rules
- if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
- if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
- changes: [ ".gitlab-ci.yml", ".gitignore", "CODEOWNERS" ]

include:
  - local: migrations/.gitlab-ci.yml
    rules:
      - *run_all_rules
      - changes: [ migrations/**/* ]
  - local: api/.gitlab-ci.yml
    rules:
      - *run_all_rules
      - changes: [ api/**/* ]
  - local: web/.gitlab-ci.yml
    rules:
      - *run_all_rules
      - changes: [ web/**/* ]
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml

default:
  tags:
    - docker
    - arm64

# Dependency scanning
dependency_scanning:
  extends: .go
  tags:
    - amd64
  variables:
    GO_VERSION: 1.23.1
  # noinspection YAMLSchemaValidation
  before_script:
    - !reference [.go, before_script]
    # Upgrade go to GO_VERSION
    - wget https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz
    - rm -rf /usr/bin/go /usr/bin/gofmt /usr/lib/go && tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz
    - export PATH=$PATH:/usr/local/go/bin
    - go version
